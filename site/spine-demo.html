<html>
	<head>
        <meta charset=utf-8>
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<style>
			body { margin: 0; }
			canvas { width: 640px; height: 480px; }
		</style>

        <script src="js/three.js"></script>
        <script src="js/spine.js"></script>
        <script src="js/OrbitControls.js"></script>
    </head>
    <body>
        <p>Testing spine rigging.</p>

        <div id="controls">
            <p>
                <select id="animation" onchange="selectAnimation()"></select>
            </p>
            <p id="skins"></p>
        </div>

		<script>
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

var renderer = new THREE.WebGLRenderer();
renderer.setSize( 640, 480 );
document.body.appendChild( renderer.domElement );

var geometry = new THREE.BoxGeometry( 1, 1, 1 );
var material = new THREE.MeshBasicMaterial( { wireframe: true, color: 0x00ff00 } );
var cube = new THREE.Mesh( geometry, material );
scene.add( cube );

camera.position.z = 5;

var controls = new THREE.OrbitControls(camera, renderer.domElement);

var loaded = false;
var assetManager = new spine.threejs.AssetManager('/spine/');
var meshFile = 'rig.json';
var atlasFile = 'rig.atlas';
assetManager.loadText(meshFile);
assetManager.loadTextureAtlas(atlasFile);

var skeletonMesh;
var skeletonData;

function selectAnimation() {
    if (!skeletonMesh) return;

    let anim = document.getElementById('animation').value;

    skeletonMesh.state.setAnimation(0, anim, true);
}

var allSkins = {};

function updateSkin() {
    if (!skeletonMesh) return;

    let skin = new spine.Skin('test');

    for (let i in allSkins) {
        if (allSkins[i].checked) {
            skin.addSkin(skeletonData.findSkin(i));
        }    
    }

    skeletonMesh.skeleton.setSkin(skin);
    skeletonMesh.skeleton.setSlotsToSetupPose();
}

function load() {
    loaded = true;

    let scale = 0.1;

    var atlas = assetManager.get(atlasFile);
    var atlasLoader = new spine.AtlasAttachmentLoader(atlas);
    var skeletonJson = new spine.SkeletonJson(atlasLoader);
    skeletonJson.scale = 0.1;
    skeletonData = skeletonJson.readSkeletonData(assetManager.get(meshFile));

    let anims = document.getElementById('animation');
    anims.innerHTML = ""; 
    for (let i in skeletonData.animations) {
        let d = document.createElement('option');
        d.value = skeletonData.animations[i].name;
        d.innerText = skeletonData.animations[i].name;
        anims.appendChild(d);
    }

    let skins = document.getElementById('skins');
    skins.innerHTML = ""; 
    allSkins = {};
    for (let i in skeletonData.skins) {
        let d = document.createElement('input');
        d.setAttribute("type", "checkbox");
        d.id = skeletonData.skins[i].name;      
        skins.appendChild(d);

        allSkins[d.id] = d;
        d.onchange = updateSkin;

        let l = document.createElement('label');
        l.htmlFor = skeletonData.skins[i].name;
        l.appendChild(document.createTextNode(skeletonData.skins[i].name));
        skins.appendChild(l);
    }

    skeletonMesh = new spine.threejs.SkeletonMesh(skeletonData);
    skeletonMesh.state.setAnimation(0, 'walk_br', true);
    
    updateSkin();

    skeletonMesh.translateY(-5);
    skeletonMesh.scale.set(scale,scale,scale);

    cube.add(skeletonMesh);
}

function animate() {
    requestAnimationFrame( animate );

    if (!loaded && assetManager.isLoadingComplete()) {
        load();
    }

    if (loaded) {
        skeletonMesh.update(0.01);
    }
	renderer.render( scene, camera );
}
animate();
		</script>
    </body>
</html>